<h1>めっちゃモダン掲示板★彡</h1>
<input name="name" size="10" placeholder="name" />
<input name="body" size="40" placeholder="comment" />
<button>POST</button>
<main></main>
<script>

function qs(query) {
  return document.querySelector(query)
}

const span = document.createElement('span');

function sanitize(text) {
  span.textContent = text;
  return span.innerHTML;
}

window.onload = () => {
  reload()
  qs("button").addEventListener("click", post)
}

async function reload() {
  const res = await fetch("/api/read.ts");
  const posts = await res.json();
  const html = `
    <ul>
      ${posts.map(([id, name, body, createdAt]) => `
        <li>${sanitize(name)} > ${sanitize(body)} <small>(${createdAt})</small></li>
      `).join("")}
    </ul>
  `;
  qs("main").innerHTML = html;
}

async function post() {
  const name = qs("[name=name]");
  const body = qs("[name=body]");

  if (!name.value) {
    alert("名前を入力してください")
    return
  }

  if (!body.value) {
    alert("コメントを入力してください")
    return
  }

  try {
    const req = await fetch("/api/post.ts", {
      method: "POST",
      headers: {
        "content-type": "application/json; charset=utf-8",
      },
      body: JSON.stringify({ user: name.value, body: body.value })
    });
    await req.text();
  } catch (e) {
    alert("投稿失敗。時間をおいてあとで試してください。")
    return
  }

  body.value = ''

  await reload()
}
</script>
